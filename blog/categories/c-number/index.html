
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Category: C# - Kamranicus</title>
  <meta name="author" content="Kamran">

  
  <meta name="description" content="Category: C#">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kamranicus.comblog/categories/c-number">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

  <body>
    <a href="/" class="home-icon">
      <img src="/images/home.png"/>
    </a>

    <div class="all-posts">
  <div class="container">
    <div class="row">
      <div class="list-title col-md-offset-2 col-md-8">
        <h4>Posts in C#</h4>
      </div>
    </div>
  </div>

  <div class="article-list">
    <div class="container">
      
        
        <div class="row">
          <div class="col-md-offset-2 col-md-8">
            <article>
  <h2><a href="/blog/2016/03/06/cors-multiple-origins-iis/">Handling Multiple Origins in CORS Using URL Rewrite</a></h2>
  
  <p>
    <p>Here&rsquo;s a quick tip if you&rsquo;re trying to figure out how to handle <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">cross-origin requests (CORS)</a> when you have multiple origins (namely, HTTP and HTTPS). This works in IIS 8.0 and above, including Azure, as long as you have the <a href="http://www.iis.net/downloads/microsoft/url-rewrite">URL Rewrite module</a> installed.</p>

<p>The CORS header looks like this:</p>

<p><code>
Access-Control-Allow-Origin: http://mydomain.com
</code></p>

<p>The spec is very strict. The header can only return a single value and it must be absolutely qualified, which means if you have a site that is served over HTTP and HTTPS (or multiple domains), you need to <em>dynamically</em> build this header in your response. Many tutorials and blog posts say to specify <code>*</code> as the value&mdash;<strong>DO NOT DO THIS!</strong> This means any origin (domain) can embed/request assets from your website. Unless you have hundreds of sites doing this (aka CDN), you should only whitelist the domains that can include resources from your site.</p>

<p>If you are sharing resources with a known number of hosts, the following method will help. If it&rsquo;s a <em>dynamic</em> list, you will need to programmatically add the <code>Access-Control-Allow-Origin</code> header depending on the incoming <code>Origin</code> header&mdash;something I won&rsquo;t cover here.</p>

<p>Rather than messing with C# and modifying outgoing responses what I ended up using was a simple URL rewrite rule, proposed by <a href="http://stackoverflow.com/a/31084390/109458">this Stack Overflow answer</a>. All it does is add a header to the outbound response when the regular expression matches&mdash;in this case, whitelisting only the HTTP and HTTPS version of my domain (or subdomain).</p>

<p>```
&lt;system.webServer>
   <httpProtocol></p>

<pre><code> &lt;customHeaders&gt;
     &lt;add name="Access-Control-Allow-Headers" value="Origin, X-Requested-With, Content-Type, Accept" /&gt;
     &lt;add name="Access-Control-Allow-Methods" value="POST,GET,OPTIONS,PUT,DELETE" /&gt;
 &lt;/customHeaders&gt;
</code></pre>

<p>   </httpProtocol></p>

<pre><code>    &lt;rewrite&gt;            
        &lt;outboundRules&gt;
            &lt;clear /&gt;                
            &lt;rule name="AddCrossDomainHeader"&gt;
                &lt;match serverVariable="RESPONSE_Access_Control_Allow_Origin" pattern=".*" /&gt;
                &lt;conditions logicalGrouping="MatchAll" trackAllCaptures="true"&gt;
                    &lt;add input="{HTTP_ORIGIN}" pattern="(http(s)?:\/\/((.+\.)?mydomain\.com))" /&gt;
                &lt;/conditions&gt;
                &lt;action type="Rewrite" value="{C:0}" /&gt;
            &lt;/rule&gt;           
        &lt;/outboundRules&gt;
    &lt;/rewrite&gt;
</code></pre>

<p> &lt;/system.webServer>
 ```</p>

<p>This is using special syntax of the URL Rewrite module (<code>RESPONSE_</code>) to add a outgoing response header (dashes replaced with underscores). Then it matches the <em>incoming</em> <code>Origin</code> header, compares the value, and if it matches includes the CORS header with the value of my domain.</p>

<p> That was all I had to do!</p>

<p> <strong>Note:</strong> Since I just converted over to always SSL, I no longer need this workaround but multiple origins is pretty common when dealing with CORS so this solution will come in handy.</p>

  </p>
  <span class="meta">
    written 








  



<time datetime="2016-03-06T15:50:00+00:00" pubdate data-updated="true">Mar 6<span>th</span>, 2016</time>
    

in
<span class="categories">
  
    <a class='category' href='/blog/categories/azure/'>Azure</a>, <a class='category' href='/blog/categories/c-number/'>C#</a>, <a class='category' href='/blog/categories/security/'>Security</a>
  
</span>


  </span>

  
</article>

          </div>
        </div>
      
        
        <div class="row">
          <div class="col-md-offset-2 col-md-8">
            <article>
  <h2><a href="/blog/2016/02/24/azure-key-vault-config-encryption-azure/">Securing Secrets Using Azure Key Vault and Config Encryption</a></h2>
  
  <p>
    <p>Secrets. We all have them. I&rsquo;m talking about secrets like your database connection strings, API keys and encryption keys. Where are you storing yours? Are you storing them&hellip;</p>

<ol>
<li>In your application&rsquo;s source code?</li>
<li>In a config file (<code>appSettings</code> or otherwise) checked into source control?</li>
<li>In a database?</li>
<li>In a managed portal, like Azure?</li>
</ol>


<p>I hope you aren&rsquo;t storing them hardcoded. You&rsquo;re probably doing option 2 or a hybrid of options 2-4. Even if you use an external data source, it&rsquo;s hard to escape the need for secrets in local development unless you force your app to rely on having connectivity which makes it hard to work offline.</p>

<p>In this post I&rsquo;m going to provide some suggestions on how to store your secrets better using Azure Key Vault and config file encryption, specifically in the context of Azure but the concepts apply to any hosting environment.</p>

  </p>
  <span class="meta">
    written 








  



<time datetime="2016-02-24T02:30:00+00:00" pubdate data-updated="true">Feb 24<span>th</span>, 2016</time>
    

in
<span class="categories">
  
    <a class='category' href='/blog/categories/azure/'>Azure</a>, <a class='category' href='/blog/categories/c-number/'>C#</a>, <a class='category' href='/blog/categories/cloud/'>Cloud</a>, <a class='category' href='/blog/categories/encryption/'>Encryption</a>, <a class='category' href='/blog/categories/secrets/'>Secrets</a>, <a class='category' href='/blog/categories/security/'>Security</a>
  
</span>


  </span>

  
    <a class="full-article-link pull-right" rel="full-article" href="/blog/2016/02/24/azure-key-vault-config-encryption-azure/">Read on &rarr;</a>
  
</article>

          </div>
        </div>
      
        
        <div class="row">
          <div class="col-md-offset-2 col-md-8">
            <article>
  <h2><a href="/blog/2016/02/09/tools-of-the-trade/">Tools of the Trade 2016</a></h2>
  
  <p>
    <p>Sometimes you get so caught up in the work you do on a daily basis that you forget what it was like to start your job on day one&mdash;not knowing anything about what tools, extensions, and general utilities you take for granted now, 6 years into your career. It seems like on a monthly basis I find a new extension or utility that is useful to me. I wanted to share my toolbelt, in case it contains something you&rsquo;ve never heard of and causes you to exclaim in excitement about something awesome that you&rsquo;ll start using today.</p>

  </p>
  <span class="meta">
    written 








  



<time datetime="2016-02-09T03:09:00+00:00" pubdate data-updated="true">Feb 9<span>th</span>, 2016</time>
    

in
<span class="categories">
  
    <a class='category' href='/blog/categories/c-number/'>C#</a>, <a class='category' href='/blog/categories/development/'>Development</a>, <a class='category' href='/blog/categories/tools/'>Tools</a>, <a class='category' href='/blog/categories/visual-studio/'>Visual Studio</a>
  
</span>


  </span>

  
    <a class="full-article-link pull-right" rel="full-article" href="/blog/2016/02/09/tools-of-the-trade/">Read on &rarr;</a>
  
</article>

          </div>
        </div>
      
        
        <div class="row">
          <div class="col-md-offset-2 col-md-8">
            <article>
  <h2><a href="/blog/2016/02/04/typewriter/">Using Typewriter to Strongly-Type Your Client-Side Models and Services</a></h2>
  
  <p>
    <p>I&rsquo;ve recently discovered <a href="http://frhagn.github.io/Typewriter/index.html">Typewriter for Visual Studio</a>, a T4-style code-generator specifically meant for generating Typescript files. I&rsquo;ve been using it since in all my projects, at work and at home. It&rsquo;s just <strong>so</strong> good. Let me explain what Typewriter does and why it&rsquo;s so awesome.</p>

  </p>
  <span class="meta">
    written 








  



<time datetime="2016-02-04T02:08:00+00:00" pubdate data-updated="true">Feb 4<span>th</span>, 2016</time>
    

in
<span class="categories">
  
    <a class='category' href='/blog/categories/c-number/'>C#</a>, <a class='category' href='/blog/categories/javascript/'>Javascript</a>, <a class='category' href='/blog/categories/knockout-dot-js/'>Knockout.js</a>, <a class='category' href='/blog/categories/typescript/'>Typescript</a>, <a class='category' href='/blog/categories/typewriter/'>Typewriter</a>, <a class='category' href='/blog/categories/visual-studio/'>Visual Studio</a>
  
</span>


  </span>

  
    <a class="full-article-link pull-right" rel="full-article" href="/blog/2016/02/04/typewriter/">Read on &rarr;</a>
  
</article>

          </div>
        </div>
      
        
        <div class="row">
          <div class="col-md-offset-2 col-md-8">
            <article>
  <h2><a href="/blog/2016/01/25/planet-wars-ai-competition-excaliburjs-csharp/">Planet Wars AI Competition With C# and Excalibur.js</a></h2>
  
  <p>
    <p><img src="https://zippy.gfycat.com/BraveBlushingImpala.gif" alt="Planet Wars" /></p>

<p>This past weekend <a href="http://twitter.com/erikonarheim">Erik</a> and I built out a <a href="https://github.com/eonarheim/planet-wars-competition">Planet Wars</a> server (written in C#) and an <a href="http://excaliburjs.com">Excalibur.js</a>-powered visualization (written in TypeScript). Planet Wars is an AI competition where you build an AI that competes against another player to control a solar system. A map consists of several planets that have different growth rates and an initial number of ships. You have to send out a &ldquo;fleet&rdquo; of ships to colonize other planets and the player who controls the most planets and has destroyed their opponent&rsquo;s ships wins the game.</p>

<p>At work we are hosting our 6th Code Camp and recently we started hosting an AI competition internally. You can find past competition agents for <a href="https://github.com/eonarheim/AntAICompetition">Ants</a> and <a href="https://github.com/eonarheim/BellTowerEscape">Elevators</a>, for example.</p>

<p>The <a href="https://github.com/eonarheim/planet-wars-competition/tree/master/PlanetWars/Scripts/game">visualization for Planet Wars</a> is fairly simple, made even simpler using the power of <a href="http://excaliburjs.com">Excalibur.js</a>, the engine we work on during our spare time. We basically just use an Excalibur timer to query the status of the game state and update the state of all the actors in the game. For moving the fleets, we just use the <a href="http://excaliburjs.com/docs/api/edge/classes/ex.actioncontext.html">Actor Action API</a>.</p>

<p>For the <a href="https://github.com/eonarheim/planet-wars-competition/tree/master/PlanetWars/Server">game server</a>, we are using a <a href="https://github.com/eonarheim/planet-wars-competition/blob/master/PlanetWars/Server/HighFrequencyTimer.cs">HighFrequencyTimer</a> to run a 30fps server and then clients just send commands via HTTP, so any kind of agent will work like Python, Perl, PowerShell, or whatever! Anything that speaks HTTP can be a client. The server runs in the context of a website so we can easily query the state using a singleton <code>GameManager</code>. This wouldn&rsquo;t work in a load-balanced environment but it doesn&rsquo;t matter since people develop agents locally and we run the simulations on one server at high-speed to produce the results. If you backed the server with a data store, you could replay games but right now there&rsquo;s only an in-memory implementation.</p>

<p>To keep the server and client models in-sync, we use <a href="http://frhagn.github.io/Typewriter/index.html">Typewriter for Visual Studio</a> which is <strong>amazing</strong> and super useful not just for syncing client/server but also generating web clients, interfaces, etc. from C# code. I plan to write a separate post on some Typewriter tips for Knockout.js and Web API.</p>

  </p>
  <span class="meta">
    written 








  



<time datetime="2016-01-25T18:30:00+00:00" pubdate data-updated="true">Jan 25<span>th</span>, 2016</time>
    

in
<span class="categories">
  
    <a class='category' href='/blog/categories/ai/'>AI</a>, <a class='category' href='/blog/categories/c-number/'>C#</a>, <a class='category' href='/blog/categories/excalibur-dot-js/'>Excalibur.js</a>, <a class='category' href='/blog/categories/games/'>Games</a>, <a class='category' href='/blog/categories/javascript/'>Javascript</a>, <a class='category' href='/blog/categories/typescript/'>Typescript</a>, <a class='category' href='/blog/categories/typewriter/'>Typewriter</a>
  
</span>


  </span>

  
</article>

          </div>
        </div>
      
        
        <div class="row">
          <div class="col-md-offset-2 col-md-8">
            <article>
  <h2><a href="/blog/2015/11/06/impersonating-during-testing/">Impersonating a User During Automated Testing Scenarios</a></h2>
  
  <p>
    <p>I&rsquo;m starting to introduce privacy controls to <a href="http://keeptrackofmygames.com">Keep Track of My Games</a> and I ran into the following scenario when writing my tests:</p>

<p>```
Scenario: Anonymous user should be able to view a public custom list</p>

<pre><code>Given a user has a list
And a user's list is public
When I request access to the list
Then I have read-only access
</code></pre>

<p>```</p>

<p>In this context, <strong>I</strong> am the anonymous user. This is the exact <a href="http://www.specflow.org/">SpecFlow</a> scenario I wrote. Do you know why I may have run into issues?</p>

<p>Let&rsquo;s look at the first two steps:</p>

<p>```c#
[Given(@&ldquo;a user has a list&rdquo;)]
public void GivenAUserHasAList() {</p>

<pre><code>_listResult = _context.ListService.CreateList(_newList)
</code></pre>

<p>}</p>

<p>[Given(@&ldquo;a user&rsquo;s list is public&rdquo;)]
public void GivenAUsersListIsPublic() {
  <em>privacySettings.Level = PrivacyLevel.Public;
  </em>context.ListService.UpdateListPrivacy(<em>listResult.Id, </em>privacySettings);
}
```</p>

<p>Why would this cause a problem with my given scenario?</p>

<ol>
<li>In the first step, I&rsquo;m creating a new list.</li>
<li>In the second step, I&rsquo;m taking the new list I just made from the first step and updating the privacy settings on it.</li>
</ol>


<p>The problem is that my service assumes the context is an authenticated user and will apply changes to the <strong>current user&rsquo;s</strong> list. Well, since I did not call my login helpers before these two steps, I am in an anonymous context so the service calls fail. That&rsquo;s good! But how can I tell my steps to call a service method <em>on behalf</em> of another user without having <em>every</em> step use the current user context?</p>

<p>You might say I should just create a new method that accepts a username and refactor my methods. I <em>could</em> do that but not only is my entire service designed around the current user context, my service layer is essentially the interface of my public API. I would never allow one user to create a list for another user (unless that was a feature). So the same way I wouldn&rsquo;t expose an API method to do something on behalf of someone, I won&rsquo;t add a public method in my service layer to do the same. I could choose to make the method private or internal and grant access to the assembly for testing&mdash;true, I <em>could</em> but that seems like a workaround where I need to expose special functionality just for testing.</p>

<p>The approach I ended up doing was simpler and more elegant and leveraged an existing pattern I was relying on: injecting an <code>IUserContext</code> into my service layer like this:</p>

<p><code>c#
public ListService(IUserContext userContext) {
  _userContext = userContext;
}
</code></p>

<p>This is using standard dependency injection (Ninject, in my case) to inject a context for the current user. That context gets created and maintained outside this class, so it doesn&rsquo;t care who provided it or where it came from, it just uses it to determine business logic.</p>

<p>So since I&rsquo;m already injecting the current user context and mocking it in my tests, why not simply swap out the context when I need to?</p>

<h2>Creating an impersonation context</h2>

<p>That&rsquo;s what I ended up doing. Here&rsquo;s my implementation of a <code>TestingImpersonationContext</code> (<a href="https://gist.github.com/kamranayub/9654d6581fbcf63cf481">https://gist.github.com/kamranayub/9654d6581fbcf63cf481</a>):</p>

<script src="https://gist.github.com/kamranayub/9654d6581fbcf63cf481.js"></script>


<p>It should be clear what&rsquo;s happening but let me explain further. Specifically in SpecFlow you can inject a context into your testing steps like so:</p>

<p>```c#
public class StepBase : TechTalk.SpecFlow.Steps {</p>

<pre><code>protected TestingContext _context;
public StepBase(TestingContext context)
{
    _context = context;
}
</code></pre>

<p>}
```</p>

<p>As long as your step classes inherit that <code>StepBase</code>, you have access to a context. All I did was build a method off that context that swapped out my existing dependency that was injected for <code>IUserContext</code> with a temporary context that impersonated the requested user. Once it is disposed, it restores the original context. Easy as pie!</p>

<p>If you are <strong>not</strong> using SpecFlow which is probably the case, don&rsquo;t fret&mdash;all you really need is a class or helper method that you can access in your test classes. However you want to achieve that is up to you. Create a base class, don&rsquo;t even bother with dependency injection, etc. This is entirely doable without DI but since my app relies on it I also leverage it during testing.</p>

<p>Now given we have an impersonation context helper, here&rsquo;s how our two testing steps have changed:</p>

<p>```c#
[Given(@&ldquo;a user has a list&rdquo;)]
public void GivenAUserHasAList() {
  using (_context.Impersonate(&ldquo;user&rdquo;) {</p>

<pre><code>_listResult = _context.ListService.CreateList(_newList);
</code></pre>

<p>  }
}</p>

<p>[Given(@&ldquo;a user&rsquo;s list is public&rdquo;)]
public void GivenAUsersListIsPublic() {</p>

<pre><code>using (_context.Impersonate("user"))
{
    _privacySettings.Level = PrivacyLevel.Public;
    _context.ListService.UpdateListPrivacy(_listResult.Id, _privacySettings);
}
</code></pre>

<p>}
```</p>

<p>I could even update my scenario to be specific about <strong>who&rsquo;s list</strong> I&rsquo;m accessing (so it&rsquo;s not ambiguous between logged in user vs. another user) but since I only have two users in my testing context, it doesn&rsquo;t really matter.</p>

<p>Now for the test results:</p>

<p><code>
Given a user has a list
-&gt; done: ListSteps.GivenAUserHasAList() (0.2s)
And a user's list is public
-&gt; done: ListSteps.GivenAUsersListIsPublic() (0.0s)
When I request access to the list
-&gt; done: ListSteps.WhenIRequestAccessToTheList() (0.1s)
Then I have read-only access
-&gt; done: ListSteps.ThenIHaveReadAccess() (0.0s)
</code></p>

<p>The tests are green and now I&rsquo;m a happy coder. By the way, if you aren&rsquo;t using <a href="http://specflow.org">SpecFlow</a> for .NET you should consider it, I love it.</p>

  </p>
  <span class="meta">
    written 








  



<time datetime="2015-11-06T16:00:00+00:00" pubdate data-updated="true">Nov 6<span>th</span>, 2015</time>
    

in
<span class="categories">
  
    <a class='category' href='/blog/categories/dot-net/'>.NET</a>, <a class='category' href='/blog/categories/c-number/'>C#</a>, <a class='category' href='/blog/categories/keep-track-of-my-games/'>Keep Track of My Games</a>, <a class='category' href='/blog/categories/specflow/'>SpecFlow</a>, <a class='category' href='/blog/categories/testing/'>Testing</a>
  
</span>


  </span>

  
</article>

          </div>
        </div>
      
        
        <div class="row">
          <div class="col-md-offset-2 col-md-8">
            <article>
  <h2><a href="/blog/2015/10/10/azure-cdn-cassette/">Using Azure CDN Origin Pull With Cassette</a></h2>
  
  <p>
    <p><strong>Update (Feb 2016)</strong>: Updated to use new CDN Profiles.</p>

<p>For the October update for <a href="http://keeptrackofmygames.com">Keep Track of My Games</a> I wanted to offload my web assets to a CDN. Since I&rsquo;m already using <a href="http://azure.com">Microsoft Azure</a> to host the site, I decided to use <a href="https://azure.microsoft.com/en-us/documentation/articles/cdn-how-to-use-cdn/">Azure CDN</a>.</p>

<p>I set it up for &ldquo;Origin Pull&rdquo; which means that instead of uploading my assets to the CDN (Azure Blob storage), you request a file from the CDN and Azure will go and get it from your website and then cache it on their servers.</p>

<p>So as an example:</p>

<p><code>
User requests http://mysite.azureedge.net/stylesheets/foo.png
|
|
CDN: have I cached "stylesheets/foo.png?"
  Yes: Serve content from edge cache (closest to user)
  No: Request http://yourwebsites.com/stylesheets/foo.png and serve
</code></p>

<p>You can read more about <a href="https://azure.microsoft.com/en-us/documentation/articles/cdn-create-new-endpoint/">how to set up origin pull in Azure CDN</a>. In my case, I used &ldquo;Custom Origin&rdquo; of &ldquo;<a href="http://keeptrackofmygames.com">http://keeptrackofmygames.com</a>&rdquo;.</p>

<h2>Using CDN with Cassette</h2>

<p>I use the .NET library <a href="http://getcassette.com">Cassette</a> for bundling &amp; minification for KTOMG&mdash;when I started KTOMG there was no Microsoft provided option and Cassette has been really stable.</p>

<p>It works pretty much as you&rsquo;d expect:</p>

<ul>
<li>Define &ldquo;bundles&rdquo; which are sets of scripts/stylesheets</li>
<li>Render bundles onto page(s)</li>
<li>If debug mode, render individually otherwise minify and concatenate</li>
</ul>


<p>By default, Cassette will render URLs like this in your source code:</p>

<p>In debug mode:</p>

<p>```
Bundle: ~/Content/core</p>

<ul>
<li>/cassette.axd/asset/Content/bootstrap.css?hash</li>
<li>/cassette.axd/asset/Content/site.css?hash</li>
<li>/cassette.axd/asset/Content/app.css?hash
```</li>
</ul>


<p>And in production:</p>

<p><code>
/cassette.axd/stylesheet/{hash}/Content/core
</code></p>

<p>But if we want to serve assets over the CDN, we need to plug in our special CDN URL prefix&mdash;not only for script/stylesheet references but also references to images <em>in</em> those files.</p>

<p>Luckily, Cassette provides a facility to modify generated URLs by letting you register a <code>IUrlGenerator</code>. Here&rsquo;s my full implementation of this for my CDN:</p>

<script src="https://gist.github.com/kamranayub/2da4ccfec3e7812c8367.js"></script>


<p>As you can see, I register a custom <code>IUrlGenerator</code> and a custom <code>IUrlModifier</code>. The default <code>IUrlModifider</code> is Cassette&rsquo;s <code>VirtualDirectoryPrepender</code> and it just prepends &ldquo;/&rdquo; to the beginning of every URL but in our case we want to conditionally prepend the Azure CDN endpoint in production.</p>

<p>In production, this will produce the following output:</p>

<p><code>
https://mysite.azureedge.net/cassette.axd/stylesheet/{hash}/Content/core
</code></p>

<p>To allow local debugging and CDN in production I just use an app setting in the web.config. In Azure, I also add an application setting (<code>CdnUrl</code>) through the portal in my production slot with the correct CDN URL and voila&mdash;all my assets will now be served over CDN.</p>

<h3>Notes</h3>

<ul>
<li><p>Azure CDN does not yet support HTTPS for custom origin domains. So if you want to serve content over <a href="http://static.yoursite.com">http://static.yoursite.com</a> you can&rsquo;t serve it over HTTPS because Azure doesn&rsquo;t allow you to upload or set a SSL certificate to use and insteads uses their own certificate which is not valid for your domain. <a href="http://feedback.azure.com/forums/169397-cdn/suggestions/1332683-allow-https-for-custom-cdn-domain-names">Vote up the UserVoice issue</a> on this.</p></li>
<li><p>Azure CDN will serve your entire site, not just assets. There may be a way to prevent browsing the site over CDN (i.e. &ldquo;assets only&rdquo;). <a href="https://social.msdn.microsoft.com/Forums/en-US/azurecdn/thread/055bb85f-0bde-4710-8c4d-bce122d5938c/">See this MSDN thread</a>. I have not yet implemented the proposed fix.</p></li>
<li><p>I am choosing <strong>not</strong> to point my entire domain to the CDN. Some folks choose to serve their entire site over the CDN which is definitely something you can do. However, in my case, I didn&rsquo;t want to do that. If you instead chose to point your domain to the CDN endpoint, you don&rsquo;t need to do any of this&mdash;<strong>everything</strong> will be served over the CDN. However, note that if your site is highly dynamic this results in a double hop&mdash;once to CDN, once to the origin, so you will not see much benefit unless your entire site is mostly static.</p></li>
</ul>


  </p>
  <span class="meta">
    written 








  



<time datetime="2015-10-10T00:30:00+00:00" pubdate data-updated="true">Oct 10<span>th</span>, 2015</time>
    

in
<span class="categories">
  
    <a class='category' href='/blog/categories/dot-net/'>.NET</a>, <a class='category' href='/blog/categories/azure/'>Azure</a>, <a class='category' href='/blog/categories/c-number/'>C#</a>, <a class='category' href='/blog/categories/keep-track-of-my-games/'>Keep Track of My Games</a>
  
</span>


  </span>

  
</article>

          </div>
        </div>
      
    </div>
  </div>
</div>

    <footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
  <a href="/"><h4>Home</h4></a>
</div>

<div class="col-md-2">
  <div class="social-icon-list">
    
    <a href="https://twitter.com/kamranayub"><img src="/images/glyphicons_social_31_twitter.png"/></a>
    

    
    <a href="https://github.com/kamranayub"><img src="/images/glyphicons_social_21_github.png"/></a>
    

    

    
  </div>
</div>

<div class="pull-right">
  <h4>Powered by <a href="http://octopress.org/">Octopress</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
</div>


    </div>
  </div>
</footer>

    
  </body>
</html>
