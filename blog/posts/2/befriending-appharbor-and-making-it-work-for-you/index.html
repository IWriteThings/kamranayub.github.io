
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Befriending AppHarbor and Making It Work for You - Kamranicus</title>
  <meta name="author" content="Kamran">

  
  <meta name="description" content="I chose to partially host my site on AppHarbor because it affords several luxuries for free: Load balancing
Automatic builds and deploys
Fast and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://kamranicus.com/blog/posts/2/befriending-appharbor-and-making-it-work-for-you">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/Kamranicus" rel="alternate" title="Kamranicus" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Kreon' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1203259-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Kamranicus</a></h1>
  
    <h2>Kamran Ayub is a developer and designer in Minneapolis, Minnesota. He specializes in .NET development with a dash of client-side and is passionate about UX.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss email">
  <li><a href="http://feeds.feedburner.com/Kamranicus" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
    <li><a href="http://feedburner.google.com/fb/a/mailverify?uri=Kamranicus" rel="subscribe-email" title="subscribe via email">Email</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:kamranicus.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Befriending AppHarbor and Making It Work for You</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-06T16:11:44-05:00" pubdate data-updated="true">Apr 6<span>th</span>, 2011</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://kamranicus.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I chose to partially host my site on <a href="http://appharbor.com">AppHarbor</a> because it affords several luxuries for <strong>free</strong>:</p>

<ul>
<li>Load balancing</li>
<li>Automatic builds and deploys</li>
<li>Fast and easy setup/maintenance</li>
<li>Private Git hosting</li>
</ul>


<p>However, it does fall short in a couple areas:</p>

<ol>
<li>Native support for a staging environment</li>
<li>Free database is only 20MB and it&rsquo;s $10/mo for a 10GB database</li>
<li>Any more instances incur about $36/mo each</li>
</ol>


<p>There are workarounds for the first two issues, which I will cover here. The third is a judgement call on your part, whether you think it&rsquo;s worth the cost. For me, I don&rsquo;t need another instance.</p>

<h2>Setting up a Staging Environment</h2>

<p>You <em>can</em> set up a staging environment in AppHarbor. I needed several things for my staging environment:</p>

<ol>
<li>Is a sub-domain</li>
<li>Is protected so only I can access it</li>
</ol>


<p>Here is what I did:</p>

<ol>
<li>In AppHarbor, create a new application (e.g. <em>Kamranicus-Dev</em>)</li>
<li>Locally, add this new application as a new remote to your Git:

<ul>
<li><code>git remote add appharbor-stage {your new app Git url}</code></li>
</ul>
</li>
<li>In the <strong>Configuration Variables</strong> section of your AppHarbor application, add a new variable:

<ul>
<li><code>RuntimeEnvironment</code> with a value of <code>Staging</code></li>
</ul>
</li>
<li>In your <strong>web.config</strong>, you can now add a new <code>appSetting</code>:

<ul>
<li><code>&lt;add key="RuntimeEnvironment" value="Local" /&gt;</code></li>
</ul>
</li>
</ol>


<p>Now, when you push to your new <code>appharbor-stage</code> remote, AppHarbor will automatically replace that app setting with the value <code>Staging</code>.</p>

<p>At this point, you&rsquo;re all done. You can now add a host name like <strong>stage.kamranicus.com</strong> to point to your staging site.</p>

<p>To push to your staging environment:</p>

<pre><code>git push appharbor-stage master
</code></pre>

<p>If you&rsquo;re wondering about connection strings, you will need to test for the current <code>RuntimeEnvironment</code> and use one of your choosing:</p>

<pre><code>var runtimeEnvironment = ConfigurationManager.AppSettings["RuntimeEnvironment"].ToString();
</code></pre>

<h3>Adding protection</h3>

<p>If you&rsquo;re like me, you don&rsquo;t want everyone looking at your new changes before they&rsquo;re ready and you sure as hell don&rsquo;t want people adding stuff to your development database.</p>

<p>I am using Forms authentication in conjunction with OpenID for Kamranicus. Thus, I needed a to make a special attribute for my <code>BaseController</code> that programmatically decided whether or not to restrict access to the controller based on the runtime environment.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Configuration</span><span class="p">;</span>
</span><span class='line'><span class="k">using</span> <span class="nn">System.Web.Mvc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="nn">System.Web.Mvc</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="k">class</span> <span class="nc">AuthorizeLocalAttribute</span> <span class="p">:</span> <span class="n">AuthorizeAttribute</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">LOCAL</span> <span class="p">=</span> <span class="s">&quot;Local&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">STAGING</span> <span class="p">=</span> <span class="s">&quot;Staging&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">AuthorizeCore</span><span class="p">(</span><span class="n">HttpContextBase</span> <span class="n">httpContext</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Ignore all Account controller calls (Anonymous)</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">RequestContext</span><span class="p">.</span><span class="n">RouteData</span><span class="p">.</span><span class="n">Values</span><span class="p">[</span><span class="s">&quot;controller&quot;</span><span class="p">].</span><span class="n">ToString</span><span class="p">()</span> <span class="p">==</span> <span class="s">&quot;Account&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Get runtime environment</span>
</span><span class='line'>          <span class="kt">string</span> <span class="n">runtimeEnvironment</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">&quot;RuntimeEnvironment&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">runtimeEnvironment</span> <span class="p">==</span> <span class="n">STAGING</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="n">AuthorizeCore</span><span class="p">(</span><span class="n">httpContext</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can then apply this attribute to your <code>BaseController</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="na">[AuthorizeLocal(Users = &quot;MyAdminID&quot;)]</span>
</span><span class='line'><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">BaseController</span> <span class="p">:</span> <span class="n">Controller</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// yada yada yada</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Does it work?</h2>

<p>This is the method I use and it seems to work great. Note that you can create any number of environments like this and programmatically do different things based on what gets injected in by AppHarbor.</p>

<h2>Taking care of storage</h2>

<p>For my blog I store all my images in the database. This means that I would quickly run over the 20MB in the free database allotted by AppHarbor. I also don&rsquo;t want to pay an extra $10/mo for a database.</p>

<p>Instead, I already have an account with <a href="http://arvixe.com">Arvixe</a> and as far as I could tell, it is not against the TOS of AppHarbor to host your database externally. So that&rsquo;s what I did. I get to use my Arvixe account for not only DB hosting, but also the mail server and other hosting provider options for a measley $10/mo (it also hosts some other sites I own).</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Kamran</span></span>

      








  


<time datetime="2011-04-06T16:11:44-05:00" pubdate data-updated="true">Apr 6<span>th</span>, 2011</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://kamranicus.com/blog/posts/2/befriending-appharbor-and-making-it-work-for-you" data-via="kamranayub" data-counturl="http://kamranicus.com/blog/posts/2/befriending-appharbor-and-making-it-work-for-you" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/posts/1/welcome-to-kamranicus-yaps" title="Previous Post: Welcome to Kamranicus [YAPS]">&laquo; Welcome to Kamranicus [YAPS]</a>
      
      
        <a class="basic-alignment right" href="/blog/posts/3/a-better-mvc-label-helper" title="Next Post: A Better MVC Label Helper">A Better MVC Label Helper &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  	<h1>About Me</h1>

  	<p><img src="http://gravatar.com/avatar/8303c4eb9f9099df39adbc3d8c634746?s=120" alt="My Headshot" title="My ugly mug" /></p>

  	<p>Hi, my name is Kamran. I am a web developer and designer, residing in Minnesota. I've been programming since 2001 and I am familiar with many different languages, both web-based and server-based. I love to tinker around and think of new ways to solve problems.</p>

	<p>If you wanna talk, tweet <strong><a href="http://twitter.com/kamranayub" target="_blank">@kamranayub</a></strong> or send me an email at my <strong>full name</strong> at <strong>gmail.com</strong></p>
</section>
<section>
  	<h1>Apps</h1>

  	<ul>
  		<li><a href="http://centwiseapp.com/">Centwise</a></li>
  		<li><a href="http://wp-bowling.tumblr.com/">Bowling Calculator</a></li>
  		<li><a href="http://keeptrackofmygames.com/">Keep Track of My Games</a></li>  		
  	</ul>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/12/18/get-your-ci-on-with-travis-ci/">Get Your CI on With Travis CI</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/10/just-released-bowling-calculator-app/">Just Released: Bowling Calculator App</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/05/miniprofiler-ravendb-pull-request-accepted/">MiniProfiler RavenDB Pull Request Accepted</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/04/kamranicus-now-with-100-percent-more-octopress/">Kamranicus: Now With 100% More Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/posts/79/just-pushed-blackjack-sample-game">Just Pushed: Blackjack Sample Game</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/kamranayub">@kamranayub</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'kamranayub',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/104789622697290911192?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Kamran -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'kamranicus';
      
        
        // var disqus_developer = 1;
        
        var disqus_identifier = '2';
        
        var disqus_url = 'http://kamranicus.com/blog/posts/2/befriending-appharbor-and-making-it-work-for-you';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
